<!doctype html>


<html lang="en">

<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="css/nav_style.css">
    <link rel="stylesheet" href="css/main_page_style.css">

</head>

<script src="jquery-3.4.1.min.js"></script>


<!--
<script src="interactivity.js"></script>
-->

<body>

<input type="checkbox" id="nav-toggle" hidden>
<label for="nav-toggle" class="nav-toggle" onclick></label>

<nav class="nav">
    <h1>Near duplicates</h1>
    <h2>Group archetype:</h2>
    <ul>
        {% for group in groups %}
            <li data-groups="{{ group['data-groups'] }}">
                <a href="graph_group_{{ group['id'] }}.html" class="tooltip_group_power"
                   data-groups="{{ group['data-groups'] }}"
                   type="{{ group['type'] }}" target="subpage_graph">
                    {{ group['id'] }} ) &nbsp; {{ group['archetype'] }}
                    <span class="tooltiptext_group_power">
                  Power of group is {{ group['power'] }}
                </span>
                </a>
            </li>
        {% endfor %}
    </ul>
</nav>


<iframe style="width:100%;height:100%" id="subpage_graph" name="subpage_graph"></iframe>

</body>


<script>


    function logging(msg) {
        if (window.qtab) {
            window.qtab.clog(msg);
        } else {
            console.log(msg);
        }
    }

    let currently_selected_data_groups = undefined;

    /**
     * Listens and updated currently_selected_data_groups for further usage for refactoring
     * and set visibility of context menu elements
     */
    $(window).on('contextmenu', function (e) {
        let elt = $(e.target);
        let li = elt.closest('li');
        if (li.length === 0) {
            logging("Disabled menu items");
            window.qtab.enable_inf_element(false);
            window.qtab.enable_dict(false);
            currently_selected_data_groups = undefined;
            return;
        }
        logging("Enabled menu items");
        currently_selected_data_groups = elt.attr('data-groups');
        if (elt.attr('type') === 'multiple') {
            window.qtab.enable_dict(false);
        } else {
            window.qtab.enable_dict(true);
        }

        window.qtab.enable_inf_element(true);
        logging('NavBar.contextMenu on currently_selected_li:' + currently_selected_data_groups);
    });

    /**
     * Calls qtab function for refactoring (create dictionary entry) document for selected groups
     */
    window.single2dict = function () {
        let data_groups = currently_selected_data_groups;
        logging("window.single2dict on:" + data_groups);
        window.qtab.refactor_create_dic_entry(data_groups);
    };

    /**
     * Calls qtab function for refactoring (create information element) document for selected groups
     */
    window.some2elem = function () {
        let data_groups = currently_selected_data_groups;
        logging("window.some2elem on" + data_groups);
        window.qtab.refactor_create_inf_elt(data_groups);
    };

    // subscribe for messages from iframe
    window.addEventListener("message", receiveMessage, false);

    /**
     * Receives event from child iframe and processes this event
     * @param event
     */
    function receiveMessage(event) {
        var source = event.source.frameElement;
        var data = event.data; //this is the message
        logging("Received message from iframe");
        if (window.qtab) {
            processWithQtab(data);
        } else {
            processWithPage(data);
        }

        function processWithQtab(data) {
            logging('Processing with qtab');

            if (data['type'] === "highlightRange") {
                let f = data['data']['range'].split('-').map(function (el) {
                    return parseInt(el)
                });
                logging('highlightRange' + f[0] + ' ' + f[1]);
                qtab.src_select(f[0], f[1], null);
            } else if (data['type'] === 'contextMenuDataGroups') {
                logging(currently_selected_data_groups);
                currently_selected_data_groups = data['data']['data-groups'];
                if (data['data']['type'] === 'multiple') {
                    window.qtab.enable_dict(false);
                } else {
                    window.qtab.enable_dict(true);
                }
                window.qtab.enable_inf_element(true);
                logging('Iframe.contextMenu on currently_selected_li:' + currently_selected_data_groups);
            }
        }

        function processWithPage() {
            logging('Processing with tab');
            if (data['type'] === "highlightRange") {
                let f = data['data']['range'].split('-').map(function (el) {
                    return parseInt(el)
                });
                logging('higlightRange' + f[0] + ' ' + f[1]);
            } else if (data['type'] === 'contextMenuDataGroups') {
                currently_selected_data_groups = data['data']['data-groups'];
                logging('Iframe.contextMenu on currently_selected_li:' + currently_selected_data_groups);
            }
        }
    }

    window.decide_enable_dict = function (x, y) {
        logging('Context menu on: ' + x + ' ' + y);
        //placeholder for qtab
    }


</script>
</html>